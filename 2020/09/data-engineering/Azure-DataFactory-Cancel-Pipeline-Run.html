<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Cancel Data Factory Pipeline Run | CloudSafari</title>
<meta name="generator" content="Jekyll v3.6.3">
<meta property="og:title" content="Cancel Data Factory Pipeline Run">
<meta name="author" content="Mohamed Sharaf">
<meta property="og:locale" content="en_US">
<meta name="description" content="In some cases you want to end the Azure Data Factory (ADF) pipeline execution based on a logic in the pipeline itself. For example, when there’s no record coming from one of the inputs datasets then you need to fail quickly to either reduce cost or to avoid any logical errors.">
<meta property="og:description" content="In some cases you want to end the Azure Data Factory (ADF) pipeline execution based on a logic in the pipeline itself. For example, when there’s no record coming from one of the inputs datasets then you need to fail quickly to either reduce cost or to avoid any logical errors.">
<meta property="og:site_name" content="CloudSafari">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-09-13T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Cancel Data Factory Pipeline Run">
<meta name="twitter:site" content="@">
<meta name="twitter:creator" content="@Mohamed Sharaf">
<script type="application/ld+json">
{"description":"In some cases you want to end the Azure Data Factory (ADF) pipeline execution based on a logic in the pipeline itself. For example, when there’s no record coming from one of the inputs datasets then you need to fail quickly to either reduce cost or to avoid any logical errors.","url":"/2020/09/data-engineering/Azure-DataFactory-Cancel-Pipeline-Run","headline":"Cancel Data Factory Pipeline Run","dateModified":"2020-09-13T00:00:00+00:00","datePublished":"2020-09-13T00:00:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/2020/09/data-engineering/Azure-DataFactory-Cancel-Pipeline-Run"},"author":{"@type":"Person","name":"Mohamed Sharaf"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    

    <!-- Site Favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/png">

    <!-- Font Embed Code -->
    <link href="https://fonts.googleapis.com/css?family=Karla:400,400i,700,700i" rel="stylesheet">

    <!-- CSS Styles -->
    <link href="/assets/css/style.css" rel="stylesheet">

</head>



<body class="layout-post">
    <div id="page" class="site">

        
        <header id="masthead" class="site-header outer">
    <div class="site-header-inside">
        <div class="site-branding">
            
                <h1 class="site-title"><a href="/" rel="home">CloudSafari</a></h1>
            
        </div>
<!-- .site-branding -->
        <nav id="main-navigation" class="site-navigation" aria-label="Primary Navigation">
            <ul class="menu">
            
                <li class="menu-item"><a href="/about/">About</a></li>
            
            </ul>
            <button id="sidebar-show" class="sidebar-toggle"><span class="screen-reader-text">Open Sidebar</span><span class="icon-more" aria-hidden="true"></span></button>
        </nav><!-- .site-navigation -->
    </div>
<!-- .site-header-inside -->
</header><!-- .site-header -->
        

        <div id="content" class="site-content fadeInDown delay_075s">
    <main id="main" class="site-main outer">
        <article class="post-full inner">
            <header class="post-header">
                <div class="post-meta">
                    <time class="post-date" datetime="2020-09-13">September 13,
                        2020</time>
                </div>
<!-- .post-meta -->
                <h1 class="posttitle">Cancel Data Factory Pipeline Run </h1>
            </header><!-- .post-header -->
            
            <div class="post-content">
                <p>In some cases you want to end the <a href="https://docs.microsoft.com/en-us/azure/data-factory/">Azure Data Factory</a> (ADF) pipeline execution based on a logic in the pipeline itself. For example, when there’s no record coming from one of the inputs datasets then you need to fail quickly to either reduce cost or to avoid any logical errors.</p>

<p>The challenge is there’s no activity in ADF that cancels execution. In this case, the <a href="https://docs.microsoft.com/en-us/azure/data-factory/control-flow-web-activity">web activity</a> comes handy</p>

<p>Let’s take a quick example, in the picture below, a simple logic pipeline that sets a variable to true and then based on the value of the variable, it has <em>If Condition</em> activity to cancel the pipeline execution when it’s true (of course it’s always true in this example, but you get the point)
<img src="/assets/images/posts/2020/adf-logic.png" alt="simple logic pipeline"></p>

<p>Inside the true branch of the <em>If Condition</em> add <em>Web</em> activity (under general) 
<img src="/assets/images/posts/2020/adf-web-activity.png" alt="Web Activity"></p>

<h3 id="now-what-are-we-trying-to-do">Now what are we trying to do?</h3>
<p>Since there’s no activity then we need to call the ADF REST API which is part of the Azure Resource Manager (https://management.azure.com) .
The API we are interested in is the <a href="https://docs.microsoft.com/en-us/rest/api/datafactory/pipelineruns/cancel">Cancel Pipeline Run API</a></p>

<p>The API format 
POST https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DataFactory/factories/{factoryName}/pipelineruns/{runId}/cancel?api-version=2018-06-01
Luckily the {factoryName} and the {runId} can be obtained using ADF functions during runtime (with a catch) using <code class="highlighter-rouge">pipeline().DataFactory</code> and <code class="highlighter-rouge">pipeline().RunId</code> respectively</p>

<p><strong>What’s the catch?</strong> 
The <code class="highlighter-rouge">RunId</code> doesn’t work when execute the pipeline under debug mode. You need to trigger the pipeline to get the correct <code class="highlighter-rouge">RunId</code>
That makes the REST call like this</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@concat('https://management.azure.com/subscriptions/***subscriptionID***/resourceGroups/***resource group name***/providers/Microsoft.DataFactory/factories/',pipeline().DataFactory,'/pipelineruns/',pipeline().RunId,'/cancel?api-version=2018-06-01')
</code></pre></div></div>

<p><strong>How about authentication?</strong>
Correct, ARM REST API calling can be daunting because of the oauth authentication workflows. Fortunately the <em>Web</em> activity supports <a href="https://docs.microsoft.com/en-us/azure/data-factory/data-factory-service-identity"><em>Managed (Service) Identity</em></a> . In nutshell, every Data Factory instance has a service identity created in Azure AD to be used by this instance.</p>

<p>The settings page should look like this</p>

<p><img src="/assets/images/posts/2020/ADF-web-activity-settings.png" alt="Web Activity Settings"></p>

<p>Note that the <code class="highlighter-rouge">resource</code> is the resource that you want to connect to which is the Azure Resource Manager (ARM) API ==&gt; https://management.azure.com</p>

<p>If you run the pipeline this way, probably you will get access denied error because this managed identity doesn’t have permissions to stop the pipeline run for this data factory. To grant this permission, assign the managed identity the Data Factory contributor Role (least privileged) or Contributor role (more privileged)</p>

<blockquote>
  <p>Note:</p>
  <blockquote>
    <p>The Managed Identity name is the same name as the data factory
There’s optional parameter to this API to cancel recursively so if the pipeline calls another pipeline, the called pipeline will be cancelled as well</p>
  </blockquote>
</blockquote>

<p>The json for the web activity is added in this code snippet.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/5bc65274365efc0bc861dae5849d72ce.js"> </script>

<!--stackedit_data:
eyJoaXN0b3J5IjpbMTIwMDc5MDY5OSwxODg0MzEwODMsLTE4ND
AwNDg0NzYsNzEzMzI0OTE4LDE5Njc1ODY5NTksOTA2NjI0MTY5
XX0=
-->

            </div>
            <footer class="post-footer">
                
                <p class="post-tags">
                     
                    <a href="tag/data-factory/">Data-Factory</a>
                    
                     
                    <a href="tag/pipeline-run/">Pipeline-Run</a>
                    
                    
                </p>
                
                <div class="post-share">
                    <span class="post-share-title">Share:</span>
                    <a target="_blank" href="https://twitter.com/share?text=Cancel+Data+Factory+Pipeline+Run+&amp;url=https://cloudsafari.ca/2020/09/data-engineering/Azure-DataFactory-Cancel-Pipeline-Run">Twitter</a>
                    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://cloudsafari.ca/2020/09/data-engineering/Azure-DataFactory-Cancel-Pipeline-Run">Facebook</a>
                </div>
<!-- .share-post -->
            </footer>
            <div class="author-box">
                <div class="author-avatar"><img src="/assets/images/authorimage.jpg" alt="Mohamed Sharaf's Picture" class="avatar"></div>
                <div class="author-details">
                    <h2 class="author-title">About Mohamed Sharaf</h2>
                    <p class="author-description">Mohamed Sharaf, Cloud Solution Architect at Microsoft and curious to learn something new. Love intelligent debate and knowing intelligent people. Amateur cyclist though I do not think I will write about my hobby here. This blog is my personal way to provide high quality material to help a fellow learner understand something, anything. I will not write until there is something worth writing and I will try to update it and engage with comments regularly.</p>
                </div>
            </div>
            
<section id="comments-area" class="comments-area">
    <h2 class="comments-title">Comments</h2>
    <div class="comments-inside">
        <div id="disqus_thread"></div>
    </div>
<!-- .comments-inside -->
    <div id="comments-overlay" class="comments-overlay">
        <a href="#" id="comments-show" class="comments-show">Show comments</a>
    </div>
<!-- .comments-overlay -->
    <script type="text/javascript">
        var disqus_shortname = 'cloudsafari-ca';
        var disqus_developer = 0;
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            dsq.setAttribute('data-timestamp', +new Date());
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a>
</noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


        </article>
        
        <section class="read-next inner">
            <h2 class="read-next-title">Read Next</h2>
            
            <article class="post">
                <header class="post-header">
                    <div class="post-meta">
                        <time class="published" datetime="September 9, 2020">September 9, 2020</time>
                    </div>
                    <h3 class="post-title"><a href="/2020/09/data-platform/Azure-Databricks-VNET-Integration">Azure Databricks Deep Dive-Networking</a></h3>
                    <p class="post-tags">
                        
                        
                        
                        <a href="/tag/azure-databricks/">Azure-databricks</a>
                        
                        
                        
                        <a href="/tag/azure-firewall/">Azure-firewall</a>
                        
                        
                        
                        <a href="/tag/vnet/">Vnet</a>
                        
                        
                        
                    </p>
                </header>
                
                <a href="/2020/09/data-platform/Azure-Databricks-VNET-Integration" class="post-thumbnail">
                    <img src="/assets/images/posts/2020/databricks_thumbnail.jpg" alt="Azure Databricks Deep Dive-Networking">
                </a>
                
            </article>
            
            
            <article class="post">
                <header class="post-header">
                    <div class="post-meta">
                        <time class="published" datetime="October 26, 2020">October 26, 2020</time>
                    </div>
                    <h3 class="post-title"><a href="/2020/10/data-platform/Call-Databricks-APIs">Call Databricks API from Logic Apps</a></h3>
                    <p class="post-tags">
                        
                        
                        
                        <a href="/tag/databricks/">Databricks</a>
                        
                        
                        
                    </p>
                </header>
                
                <a href="/2020/10/data-platform/Call-Databricks-APIs" class="post-thumbnail">
                    <img src="/assets/images/posts/2020/databricks-api-thumbnail.png" alt="Call Databricks API from Logic Apps">
                </a>
                
            </article>
            
        </section><!-- .read-next -->
    </main><!-- .site-main -->
</div>
<!-- .site-content -->

        

        

        <footer id="colophon" class="site-footer outer">
            <div class="site-footer-inside">
                <p class="social-links">
    
    <a href="https://twitter.com/@mohamsharaf" target="_blank">
        <span class="fa-twitter fa" aria-hidden="true"></span>
        <span class="screen-reader-text">Twitter</span>
    </a>
    
    
    
    <a href="https://github.com/mosharafMS" target="_blank">
        <span class="fa-github fa" aria-hidden="true"></span>
        <span class="screen-reader-text">GitHub</span>
    </a>
    
    
    
    
    <a href="https://medium.com/@mohamed.sharaf" target="_blank">
        <span class="fa-medium fa" aria-hidden="true"></span>
        <span class="screen-reader-text">medium</span>
    </a>
    
    
    
    
    <a href="https://www.linkedin.com/in/mosharafms" target="_blank">
        <span class="fa-linkedin fa" aria-hidden="true"></span>
        <span class="screen-reader-text">Linkedin</span>
    </a>
    
    
</p>
                <p class="site-info">
                    <a href="#">CloudSafari</a> © 2021 . <br>
                    Powered by <a target="_blank" href="https://jekyllrb.com/">Jekyll</a>.
                </p>
                <p class="back-to-top">
                    <a id="top-button" class="top-button" href="#page">
                        <span class="icon-arrow-up" aria-hidden="true"></span>
                        <span class="screen-reader-text">Back to top</span>
                    </a>
                </p>
            </div>
<!-- .site-footer-inside -->
        </footer><!-- .site-footer -->
    </div>
<!-- .site -->
    <div id="site-overlay" class="site-overlay"></div>
    <aside id="sidebar" class="sidebar">
	<div class="sidebar-scrollable">
		<div class="sidebar-inside">
			<button id="sidebar-hide" class="sidebar-toggle"><span class="screen-reader-text">Close Sidebar</span><span aria-hidden="true" class="icon-close"></span></button>
			<nav id="sidebar-navigation" class="widget site-navigation">
				<h2 class="widget-title">Explore Site</h2>
				<ul class="menu">
					
						<li class="menu-item"><a href="/about/">About</a></li>
					
				</ul>
			</nav>
			
<section class="widget widget-text">
    <h2 class="widget-title">About CloudSafari</h2>
    <p>CloudSafari is my personal window to share about my work and technical projects. All information are provided as is and my views only represent myself</p>
</section>


<section class="widget widget-recent-posts">
    <h2 class="widget-title">Recent Articles</h2>
    <ul>
        
        <li>
            <div class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="??">February 13, 2021</time>
                </div>
                <div class="post-title">
                    <a href="/2021/02/data-platform/Data-Analytics-Review">Data Analytics Basics - Critical Review</a>
                </div>
            </div>
            
            <a class="post-thumbnail" href="/2021/02/data-platform/Data-Analytics-Review">
                <img src="/assets/images/posts/2021/analytics-thumbnail.jpg" alt="Data Analytics Basics - Critical Review">
            </a>
            
        </li>
        
        <li>
            <div class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="??">October 26, 2020</time>
                </div>
                <div class="post-title">
                    <a href="/2020/10/data-platform/Call-Databricks-APIs">Call Databricks API from Logic Apps</a>
                </div>
            </div>
            
            <a class="post-thumbnail" href="/2020/10/data-platform/Call-Databricks-APIs">
                <img src="/assets/images/posts/2020/databricks-api-thumbnail.png" alt="Call Databricks API from Logic Apps">
            </a>
            
        </li>
        
        <li>
            <div class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="??">September 13, 2020</time>
                </div>
                <div class="post-title">
                    <a href="/2020/09/data-engineering/Azure-DataFactory-Cancel-Pipeline-Run">Cancel Data Factory Pipeline Run </a>
                </div>
            </div>
            
            <a class="post-thumbnail" href="/2020/09/data-engineering/Azure-DataFactory-Cancel-Pipeline-Run">
                <img src="/assets/images/posts/2020/ADF-thumbnail.jpg" alt="Cancel Data Factory Pipeline Run ">
            </a>
            
        </li>
        
    </ul>
</section>

<!-- Create a sorted array of tags -->
 
<section class="widget widget-tagcloud">
    <h2 class="widget-title">Tags</h2>
    <div class="tagcloud">
        
        <a href="https://cloudsafari.ca/tag/azure-databricks/">Azure-Databricks</a>
        
        <a href="https://cloudsafari.ca/tag/azure-firewall/">Azure-Firewall</a>
        
        <a href="https://cloudsafari.ca/tag/data-factory/">Data-Factory</a>
        
        <a href="https://cloudsafari.ca/tag/data-hub/">Data-Hub</a>
        
        <a href="https://cloudsafari.ca/tag/data-lake/">Data-Lake</a>
        
        <a href="https://cloudsafari.ca/tag/data-warehouse/">Data-Warehouse</a>
        
        <a href="https://cloudsafari.ca/tag/databricks/">Databricks</a>
        
        <a href="https://cloudsafari.ca/tag/pipeline-run/">Pipeline-Run</a>
        
        <a href="https://cloudsafari.ca/tag/vnet/">VNET</a>
        
    </div>
</section>


		</div>
<!-- .sidebar-inside -->
	</div>
<!-- .sidebar-scrollable -->
</aside><!-- .sidebar -->
    
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177612139-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-177612139-1', { 'anonymize_ip': true });
  </script>
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "5ei8glh2oh");
</script>

    <!-- Javascript Assets -->
    <script src="/assets/js/jquery-3.3.1.min.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/custom.js"></script>

</body>

</html>
